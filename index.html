<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Pro Dashboard v7</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Orbitron:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4880FF;
            --bg: #FFFFFF;
            --text: #1a1a1a;
            --chat-size: 13px;
            --chat-weight: 600;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* HEADER */
        .header {
            position: fixed; top: 0; width: 100%; height: 75px;
            background: white; display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 1px solid #f0f0f0; z-index: 1001;
        }
        .header-left, .header-right { display: flex; gap: 10px; flex: 1; }
        .header-right { justify-content: flex-end; }
        .header-center { text-align: center; flex: 1.5; }

        .time-text { font-family: 'Orbitron', sans-serif; font-weight: 800; font-size: 1.3rem; color: #111; display: block; }
        .date-text { font-size: 0.65rem; color: #aaa; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

        /* BUTONLAR */
        .btn-icon {
            width: 42px; height: 42px; border-radius: 12px; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: all 0.2s; background: #fff;
            border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .btn-icon:active { transform: scale(0.92); }
        .btn-gemini { background: #FFC107 !important; color: white !important; border: none !important; }
        .btn-save { background: var(--primary) !important; color: white !important; border: none !important; }

        /* HABER AKI≈ûI */
        #newsFeed {
            margin-top: 85px; height: calc(100vh - 85px);
            overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px;
        }
        .news-card {
            background: white; border-radius: 20px; padding: 12px; display: flex; gap: 12px;
            border: 1px solid #f3f3f3; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
        .news-card img { width: 80px; height: 80px; border-radius: 14px; object-fit: cover; flex-shrink: 0; background: #f9f9f9; }
        .news-title { font-size: 0.92rem; font-weight: 700; color: #222; line-height: 1.4; }
        .news-meta { font-size: 0.65rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 4px; }

        /* MODAL */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px); display: none; z-index: 5000;
            justify-content: center; align-items: flex-end;
        }
       /* MODAL ANA YAPI */
/* MODAL ANA YAPI - ≈ûEFFAFLIK Gƒ∞DERƒ∞LDƒ∞ */
/* --- TERTEMƒ∞Z MODAL YAPISI (TIPSIZLIƒûE SON) --- */
.modal {
    display: flex;
    flex-direction: column;
    height: 70vh !important; /* Pencere boyu sabit */
    background: #FFFFFF !important;
    border-radius: 20px 20px 0 0;
    overflow: hidden;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    flex-shrink: 0; /* Ba≈ülƒ±k yukarƒ±da sabit kalsƒ±n */
}

.modal-body {
    flex: 1; /* Liste t√ºm orta alanƒ± doldursun */
    overflow-y: auto; /* Sadece burasƒ± kaysƒ±n */
    padding: 20px;
    -webkit-overflow-scrolling: touch;
}

.modal-footer {
    padding: 15px 20px 30px 20px;
    border-top: 1px solid #eee;
    background: white;
    flex-shrink: 0; /* Buton en altta sabit kalsƒ±n */
}

/* ORTA ALAN - AYARLAR VE Lƒ∞STELER */
.modal-body {
    flex: 1; /* Kalan t√ºm bo≈üluƒüu doldurur */
    overflow-y: auto; /* ƒ∞√ßerik ta≈üarsa kaydƒ±rma √ßubuƒüu √ßƒ±kar */
    padding: 20px;
    background: #FFFFFF;
    /* Kaydƒ±rma √ßubuƒüunu gizlemek ama kaydƒ±rmayƒ± tutmak istersen: */
    scrollbar-width: none; /* Firefox i√ßin */
}
.modal-body::-webkit-scrollbar {
    display: none; /* Chrome/Safari i√ßin √ßubuƒüu gizler, temiz durur */
}

/* AYAR SATIRLARI (Hƒ∞ZALAMA BURADA D√úZELƒ∞YOR) */
.set-row {
    margin-bottom: 25px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.set-label {
    font-size: 0.75rem;
    font-weight: 800;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 5px;
}

/* KONTROL KUTUSU (Geni≈ü ve profesyonel) */
.set-ctrl {
    display: flex;
    align-items: center;
    background: #f8f9fb;
    border: 2px solid #edf0f5;
    border-radius: 18px;
    height: 60px; /* Daha rahat dokunma alanƒ± */
    overflow: hidden;
    transition: 0.3s;
}

.set-ctrl:focus-within {
    border-color: var(--primary);
}

.set-ctrl button {
    flex: 1;
    height: 100%;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    font-weight: 400;
    color: var(--primary);
    cursor: pointer;
}

.set-ctrl button:active {
    background: #eef2ff;
}

.set-ctrl span {
    flex: 2;
    text-align: center;
    font-weight: 800;
    font-size: 1.1rem;
    color: #111;
    border-left: 1px solid #eee;
    border-right: 1px solid #eee;
}

/* ALT SABƒ∞T BUTON (KAYDET / KAPAT) */
.modal-footer {
    padding: 15px 20px 35px 20px;
    background: white;
    border-top: 1px solid #f2f2f2;
}

.btn-full {
    width: 100%;
    height: 55px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 18px;
    font-size: 1rem;
    font-weight: 800;
    box-shadow: 0 10px 20px rgba(72, 128, 255, 0.2);
    cursor: pointer;
}
/* CHAT KUTUSU AYARI (MODAL BODY ƒ∞√áƒ∞NDE) */
.chat-box {
    background: #f8faff;
    border-radius: 20px;
    padding: 15px;
    margin: 15px 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
    border: 1px solid #eef2ff;
    /* Sabit y√ºkseklik yerine i√ßeriƒüe g√∂re uzasƒ±n, body scroll olacak */
}
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* CHAT */
        .chat-box {
            background: #f8faff; border-radius: 20px; padding: 15px; height: 260px;
            overflow-y: auto; margin: 15px 0; display: flex; flex-direction: column; gap: 10px;
            border: 1px solid #eef2ff;
        }
        .msg {
            max-width: 85%; padding: 12px 16px; border-radius: 18px;
            font-size: var(--chat-size); font-weight: var(--chat-weight);
            line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word;
        }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.ai { background: white; border: 1px solid #e0e6ed; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* TOAST Bƒ∞LDƒ∞Rƒ∞M */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: white; padding: 12px 25px; border-radius: 50px; font-weight: 800; font-size: 0.85rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 2px solid var(--primary);
            z-index: 9999; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* WEB BROWSER */
        #webWin { position: fixed; inset: 0; background: white; z-index: 6000; display: none; flex-direction: column; }
        .web-bar { height: 65px; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 15px; gap: 10px; }
    </style>
</head>
<body>

    <div id="toast">ƒ∞≈ülem Ba≈üarƒ±lƒ±</div>

    <header class="header">
        <div class="header-left">
            <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="btn-icon btn-gemini" onclick="openGeneralChat()">‚ú®</button>
        </div>
        <div class="header-center">
            <span class="time-text" id="clk">00:00</span>
            <span class="date-text" id="dt">Y√úKLENƒ∞YOR</span>
        </div>
        <div class="header-right">
            <button class="btn-icon btn-save" onclick="openSavedList()">üíæ</button>
            <button class="btn-icon" onclick="location.reload()">üîÑ</button>
        </div>
    </header>

    <main id="newsFeed"></main>

    <div class="overlay" id="ovl"><div class="modal" id="mdl"></div></div>

    <div id="webWin">
        <div class="web-bar">
            <button class="btn-icon" onclick="closeWeb()">‚¨ÖÔ∏è</button>
            <div style="flex:1; text-align:center; font-weight:800; font-size:0.75rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="webTit">Site</div>
            <button class="btn-icon btn-gemini" onclick="closeWeb()">‚ú®</button>
        </div>
        <iframe id="ifr" style="flex:1; border:none;"></iframe>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="white">
<meta name="apple-mobile-web-app-title" content="Gemini AI">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1624/1624453.png">

<script>
  // Service Worker Kaydƒ±
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('PWA Hazƒ±r!'))
        .catch(err => console.log('Hata:', err));
    });
  }
</script>
    
<script>
    // API VE AYARLAR
    const KHOJ_KEY = 'kk-ZeYLGGpxj0XScjEsTpgo4Aj2VjgJwtMJodqoyEsYtUI';
    const KHOJ_URL = "https://white-heart-ea96.06mmt8129.workers.dev/";
    
    const fbCfg = { apiKey: "AIzaSyAwQfifK4eaSrSjKpA776hD0RAlx_6a2_w", databaseURL: "https://piyasa-9049c-default-rtdb.firebaseio.com", projectId: "piyasa-9049c" };
    firebase.initializeApp(fbCfg);
    const db = firebase.database();

    // Ayarlarƒ± Firebase veya LocalStorage uyumlu hale getirdik
    let sets = { size: 16, weight: 900, speed: 20, effect: 'typewriter' };
    let news = [];
    let active = null;

    function updateTime() {
        const n = new Date();
        const clk = document.getElementById('clk');
        const dt = document.getElementById('dt');
        if(clk) clk.innerText = n.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
        if(dt) dt.innerText = n.toLocaleDateString('tr-TR', {day:'numeric', month:'long'}).toUpperCase();
    }
    setInterval(updateTime, 1000); updateTime();

    // G√ñRSEL AYIKLAMA
    function getBestImage(item, source) {
        if(item.enclosure?.link) return item.enclosure.link;
        if(item.thumbnail) return item.thumbnail;
        if (item.description && item.description.includes('<img')) {
            const regex = /<img[^>]+src="([^">]+)"/g;
            const match = regex.exec(item.description);
            if (match && match[1]) return match[1];
        }
        return 'https://via.placeholder.com/100';
    }

    // HABERLERƒ∞ √áEK
    const sMap = { 'haber_trt': 'TRT', 'haber_cnn': 'CNN', 'haber_ntv': 'NTV', 'haber_webtekno': 'WEBTEKNO', 'haber_shiftdelete': 'SDN' };
    Object.keys(sMap).forEach(key => {
        db.ref(key + "/items").on("value", snap => {
            if(snap.val()) {
                const data = snap.val().slice(0, 10).map(i => ({...i, source: sMap[key]}));
                news = news.filter(x => x.source !== sMap[key]).concat(data).sort(() => Math.random() - 0.5);
                render();
            }
        });
    });

    function render() {
        const f = document.getElementById('newsFeed'); if(!f) return;
        f.innerHTML = news.map((n, i) => `
            <div class="news-card" onclick="openDetail(${i})">
                <img src="${getBestImage(n, n.source)}">
                <div style="flex:1">
                    <div class="news-meta">${n.source}</div>
                    <div class="news-title">${n.title}</div>
                </div>
            </div>`).join('');
    }

    // --- GELƒ∞≈ûMƒ∞≈û AYARLAR PANELƒ∞ (ƒ∞STEDƒ∞ƒûƒ∞N Gƒ∞Bƒ∞) ---
    function openSettings() {
        const m = document.getElementById('mdl');
        m.innerHTML = `
            <div class="modal-header"><h2 style="color:var(--primary)">‚öôÔ∏è AYARLAR</h2></div>
            <div class="modal-body">
                <div class="set-row">
                    <label class="set-label">YAZI BOYUTU</label>
                    <div class="set-ctrl">
                        <button onclick="adjustSet('size',-1)">-</button>
                        <span>${sets.size}PX</span>
                        <button onclick="adjustSet('size',1)">+</button>
                    </div>
                </div>
                <div class="set-row">
                    <label class="set-label">YAZI KALINLIƒûI</label>
                    <div class="set-ctrl">
                        <button onclick="adjustSet('weight',-100)">-</button>
                        <span>${sets.weight}</span>
                        <button onclick="adjustSet('weight',100)">+</button>
                    </div>
                </div>
                <div class="set-row">
                    <label class="set-label">DAKTƒ∞LO HIZI (MS)</label>
                    <div class="set-ctrl">
                        <button onclick="adjustSet('speed',-5)">-</button>
                        <span>${sets.speed}</span>
                        <button onclick="adjustSet('speed',5)">+</button>
                    </div>
                </div>
                <div class="set-row">
                    <label class="set-label">YAZI EFEKTƒ∞</label>
                    <select id="effSel" onchange="adjustSet('effect', this.value)" style="width:100%; padding:15px; border-radius:15px; border:2px solid #edf0f5; font-weight:800;">
                        <option value="typewriter" ${sets.effect==='typewriter'?'selected':''}>DAKTƒ∞LO</option>
                        <option value="fade" ${sets.effect==='fade'?'selected':''}>SOLARAK</option>
                        <option value="slide" ${sets.effect==='slide'?'selected':''}>KAYARAK</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-full" onclick="closeM()">KAYDET VE KAPAT</button></div>`;
        document.getElementById('ovl').style.display = 'flex';
    }

    function adjustSet(k, v) {
        if(k === 'effect') sets[k] = v;
        else sets[k] = Math.max(1, (sets[k] || 0) + v);
        
        document.documentElement.style.setProperty('--chat-size', sets.size + 'px');
        document.documentElement.style.setProperty('--chat-weight', sets.weight);
        openSettings();
    }

    // HABER DETAY
    function openDetail(idx) {
        if(idx === -1) active = {title: "Genel Sohbet", source: "KHOJ", description: "Buyur abi, seni dinliyorum."};
        else if(idx !== -2) active = news[idx];

        const m = document.getElementById('mdl');
        m.innerHTML = `
            <div class="modal-header">
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <span class="news-meta">${active.source}</span>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-icon" onclick="saveNews()">üíæ</button>
                        <button class="btn-icon" style="color:red" onclick="closeM()">‚ùå</button>
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom:10px;">${active.title}</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">${active.description?.replace(/<[^>]*>?/gm, '').substring(0,200)}...</p>
                <div class="chat-box" id="cBox" style="min-height:200px;">
                    <div class="msg ai">Analiz i√ßin hazƒ±rƒ±m abi. Ne sormak istersin?</div>
                </div>
            </div>
            <div class="modal-footer">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="uInp" placeholder="Bir ≈üey sor..." style="flex:1; padding:12px; border-radius:12px; border:1px solid #ddd;">
                    <button class="btn-icon btn-save" onclick="ask()">‚û§</button>
                </div>
            </div>`;
        document.getElementById('ovl').style.display = 'flex';
    }

    async function ask() {
        const inp = document.getElementById('uInp'); const box = document.getElementById('cBox');
        if(!inp.value) return; 
        const q = inp.value; inp.value = '';
        box.innerHTML += `<div class="msg user">${q}</div>`;
        
        const ai = document.createElement('div'); ai.className = 'msg ai'; ai.innerHTML = '...';
        box.appendChild(ai); box.scrollTop = box.scrollHeight;

        try {
            const res = await fetch(KHOJ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${KHOJ_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: `Haber: ${active.title}. Soru: ${q}`, stream: false })
            });
            const d = await res.json();
            
            // KHOJ FORMATLAMA: Kalƒ±nlarƒ± kƒ±rmƒ±zƒ± yap, maddeleri d√ºzenle, bo≈üluklarƒ± koru
            let raw = d.response
                .replace(/\*\*(.*?)\*\*/g, '<b style="color:#ef4444;">$1</b>') // Kalƒ±n -> Kƒ±rmƒ±zƒ±
                .replace(/^\s*[\-\*]\s+/gm, 'üîπ ') // Maddeler
                .replace(/\n/g, '<br>'); // Satƒ±r ba≈ülarƒ±

            ai.innerHTML = '';
            if(sets.effect === 'typewriter') {
                let i = 0;
                function type() {
                    if (i < raw.length) {
                        if (raw.substr(i, 1) === '<') {
                            let end = raw.indexOf('>', i) + 1;
                            ai.innerHTML += raw.substring(i, end);
                            i = end;
                        } else {
                            ai.innerHTML += raw.charAt(i);
                            i++;
                        }
                        box.scrollTop = box.scrollHeight;
                        setTimeout(type, sets.speed);
                    }
                }
                type();
            } else {
                ai.innerHTML = raw;
                ai.style.animation = sets.effect === 'fade' ? 'slideUp 0.5s ease' : 'none';
                box.scrollTop = box.scrollHeight;
            }
        } catch (e) { ai.innerText = "Hata olu≈ütu abi!"; }
    }

    function closeM() { document.getElementById('ovl').style.display = 'none'; }
    function saveNews() { showToast("Kaydedildi!"); }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
</script>
</body>
</html>
