<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Pro Dashboard v7</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Orbitron:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4880FF;
            --bg: #FFFFFF;
            --text: #1a1a1a;
            --chat-size: 13px;
            --chat-weight: 600;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* HEADER */
        .header {
            position: fixed; top: 0; width: 100%; height: 75px;
            background: white; display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 1px solid #f0f0f0; z-index: 1001;
        }
        .header-left, .header-right { display: flex; gap: 10px; flex: 1; }
        .header-right { justify-content: flex-end; }
        .header-center { text-align: center; flex: 1.5; }

        .time-text { font-family: 'Orbitron', sans-serif; font-weight: 800; font-size: 1.3rem; color: #111; display: block; }
        .date-text { font-size: 0.65rem; color: #aaa; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

        /* BUTONLAR */
        .btn-icon {
            width: 42px; height: 42px; border-radius: 12px; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: all 0.2s; background: #fff;
            border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .btn-icon:active { transform: scale(0.92); }
        .btn-gemini { background: #FFC107 !important; color: white !important; border: none !important; }
        .btn-save { background: var(--primary) !important; color: white !important; border: none !important; }

        /* HABER AKIÅI */
        #newsFeed {
            margin-top: 85px; height: calc(100vh - 85px);
            overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px;
        }
        .news-card {
            background: white; border-radius: 20px; padding: 12px; display: flex; gap: 12px;
            border: 1px solid #f3f3f3; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
        .news-card img { width: 80px; height: 80px; border-radius: 14px; object-fit: cover; flex-shrink: 0; background: #f9f9f9; }
        .news-title { font-size: 0.92rem; font-weight: 700; color: #222; line-height: 1.4; }
        .news-meta { font-size: 0.65rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 4px; }

        /* MODAL */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px); display: none; z-index: 5000;
            justify-content: center; align-items: flex-end;
        }
       /* MODAL ANA YAPI */
/* MODAL ANA YAPI - ÅEFFAFLIK GÄ°DERÄ°LDÄ° */
/* --- TERTEMÄ°Z MODAL YAPISI (TIPSIZLIÄE SON) --- */
.modal {
    width: 98%; /* Ä°nce gÃ¶rÃ¼nÃ¼mÃ¼ bitiren sihirli deÄŸnek */
    max-width: 500px; /* Ã‡ok bÃ¼yÃ¼k ekranlarda devasa olmasÄ±n diye sigorta */
    display: flex;
    width: 96% !important; /* EkranÄ±n yanlarÄ±na iyice yayÄ±lmasÄ± iÃ§in */
    flex-direction: column;
    height: 95vh !important; /* Pencere boyu sabit */
    background: #FFFFFF !important;
    border-radius: 20px 20px 0 0;
    overflow: hidden;
    margin: 0 auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    flex-shrink: 0; /* BaÅŸlÄ±k yukarÄ±da sabit kalsÄ±n */
}

.modal-body {
    flex: 1; /* Liste tÃ¼m orta alanÄ± doldursun */
    overflow-y: auto; /* Sadece burasÄ± kaysÄ±n */
    padding: 20px;
    -webkit-overflow-scrolling: touch;
}

.modal-footer {
    padding: 15px 20px 30px 20px;
    border-top: 1px solid #eee;
    background: white;
    flex-shrink: 0; /* Buton en altta sabit kalsÄ±n */
}

/* ORTA ALAN - AYARLAR VE LÄ°STELER */
.modal-body {
    flex: 1; /* Kalan tÃ¼m boÅŸluÄŸu doldurur */
    overflow-y: auto; /* Ä°Ã§erik taÅŸarsa kaydÄ±rma Ã§ubuÄŸu Ã§Ä±kar */
    padding: 20px;
    background: #FFFFFF;
    /* KaydÄ±rma Ã§ubuÄŸunu gizlemek ama kaydÄ±rmayÄ± tutmak istersen: */
    scrollbar-width: none; /* Firefox iÃ§in */
}
.modal-body::-webkit-scrollbar {
    display: none; /* Chrome/Safari iÃ§in Ã§ubuÄŸu gizler, temiz durur */
}

/* AYAR SATIRLARI (HÄ°ZALAMA BURADA DÃœZELÄ°YOR) */
.set-row {
    margin-bottom: 25px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.set-label {
    font-size: 0.75rem;
    font-weight: 800;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 5px;
}

/* KONTROL KUTUSU (GeniÅŸ ve profesyonel) */
.set-ctrl {
    display: flex;
    align-items: center;
    background: #f8f9fb;
    border: 2px solid #edf0f5;
    border-radius: 18px;
    height: 60px; /* Daha rahat dokunma alanÄ± */
    overflow: hidden;
    transition: 0.3s;
}

.set-ctrl:focus-within {
    border-color: var(--primary);
}

.set-ctrl button {
    flex: 1;
    height: 100%;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    font-weight: 400;
    color: var(--primary);
    cursor: pointer;
}

.set-ctrl button:active {
    background: #eef2ff;
}

.set-ctrl span {
    flex: 2;
    text-align: center;
    font-weight: 800;
    font-size: 1.1rem;
    color: #111;
    border-left: 1px solid #eee;
    border-right: 1px solid #eee;
}

/* ALT SABÄ°T BUTON (KAYDET / KAPAT) */
.modal-footer {
    padding: 15px 20px 35px 20px;
    background: white;
    border-top: 1px solid #f2f2f2;
}

.btn-full {
    width: 100%;
    height: 55px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 18px;
    font-size: 1rem;
    font-weight: 800;
    box-shadow: 0 10px 20px rgba(72, 128, 255, 0.2);
    cursor: pointer;
}
/* CHAT KUTUSU AYARI (MODAL BODY Ä°Ã‡Ä°NDE) */
.chat-box {
    background: #f8faff;
    flex: 1; /* Pencerenin geri kalan tÃ¼m boÅŸluÄŸunu doldursun */
    border-radius: 20px;
    padding: 15px;
    flex: 1; /* AltÄ±ndaki boÅŸluÄŸu otomatik doldurur ve inputa yaklaÅŸÄ±r */
    overflow-y: auto;
    margin: 15px 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
    border: 1px solid #eef2ff;
    margin-bottom: 10px; /* Input ile arasÄ±nda az bir mesafe bÄ±rakÄ±r */
    border: none; /* Gereksiz Ã§izgileri atÄ±yoruz */
    /* Sabit yÃ¼kseklik yerine iÃ§eriÄŸe gÃ¶re uzasÄ±n, body scroll olacak */
padding-bottom: 300px !important; /* MesajlarÄ±n bittiÄŸi yerin altÄ±nda 50px boÅŸluk bÄ±rakÄ±r */
}
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* CHAT */
        .chat-box {
            background: #f8faff; border-radius: 20px; padding: 15px; flex: 1; /* AltÄ±ndaki boÅŸluÄŸu otomatik doldurur ve inputa yaklaÅŸÄ±r */ 
            overflow-y: auto; margin: 15px 0; display: flex; flex-direction: column; gap: 10px;
            border: 1px solid #eef2ff; margin-bottom: 10px; /* Input ile arasÄ±nda az bir mesafe bÄ±rakÄ±r */
        padding-bottom: 300px !important; /* MesajlarÄ±n bittiÄŸi yerin altÄ±nda 50px boÅŸluk bÄ±rakÄ±r */
        }
        .msg {
            max-width: 92%; padding: 12px 16px; border-radius: 18px;
            font-size: var(--chat-size); font-weight: var(--chat-weight);
            line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word;
        }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.ai { background: white; border: 1px solid #e0e6ed; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* TOAST BÄ°LDÄ°RÄ°M */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: white; padding: 12px 25px; border-radius: 50px; font-weight: 800; font-size: 0.85rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 2px solid var(--primary);
            z-index: 9999; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* WEB BROWSER */
        #webWin { position: fixed; inset: 0; background: white; z-index: 6000; display: none; flex-direction: column; }
        .web-bar { height: 65px; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 15px; gap: 10px; }
    </style>
</head>
<body>

    <div id="toast">Ä°ÅŸlem BaÅŸarÄ±lÄ±</div>

    <header class="header">
        <div class="header-left">
            <button class="btn-icon" onclick="openSettings()">âš™ï¸</button>
            <button class="btn-icon btn-gemini" onclick="openGeneralChat()">âœ¨</button>
        </div>
        <div class="header-center">
            <span class="time-text" id="clk">00:00</span>
            <span class="date-text" id="dt">YÃœKLENÄ°YOR</span>
        </div>
        <div class="header-right">
            <button class="btn-icon btn-save" onclick="openSavedList()">ğŸ’¾</button>
            <button class="btn-icon" onclick="location.reload()">ğŸ”„</button>
        </div>
    </header>

    <main id="newsFeed"></main>

    <div class="overlay" id="ovl"><div class="modal" id="mdl"></div></div>

    <div id="webWin">
        <div class="web-bar">
            <button class="btn-icon" onclick="closeWeb()">â¬…ï¸</button>
            <div style="flex:1; text-align:center; font-weight:800; font-size:0.75rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="webTit">Site</div>
            <button class="btn-icon btn-gemini" onclick="closeWeb()">âœ¨</button>
        </div>
        <iframe id="ifr" style="flex:1; border:none;"></iframe>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="white">
<meta name="apple-mobile-web-app-title" content="Gemini AI">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1624/1624453.png">

<script>
  // Service Worker KaydÄ±
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('PWA HazÄ±r!'))
        .catch(err => console.log('Hata:', err));
    });
  }
</script>
    
<script>
    // --- 1. AYARLAR VE DEÄÄ°ÅKENLER ---
    const KHOJ_KEY = 'kk-ZeYLGGpxj0XScjEsTpgo4Aj2VjgJwtMJodqoyEsYtUI';
    const KHOJ_URL = "https://white-heart-ea96.06mmt8129.workers.dev/";
    
    const fbCfg = { 
        apiKey: "AIzaSyAwQfifK4eaSrSjKpA776hD0RAlx_6a2_w", 
        databaseURL: "https://piyasa-9049c-default-rtdb.firebaseio.com", 
        projectId: "piyasa-9049c" 
    };
    if (!firebase.apps.length) firebase.initializeApp(fbCfg);
    const db = firebase.database();

    let sets = JSON.parse(localStorage.getItem('khoj_sets')) || { size: 13, weight: 600, speed: 0, effect: 'typewriter' };
    let chatHistory = JSON.parse(localStorage.getItem('khoj_ai_history')) || [];
    let news = [];
    let active = null;

    // --- 2. SÄ°STEM BAÅLATICI ---
    function updateTime() {
        const n = new Date();
        const clk = document.getElementById('clk');
        const dt = document.getElementById('dt');
        if(clk) clk.innerText = n.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
        if(dt) dt.innerText = n.toLocaleDateString('tr-TR', {day:'numeric', month:'long'}).toUpperCase();
    }
    setInterval(updateTime, 1000); 
    updateTime();
    applySets();

    // --- 3. HABER SÄ°STEMÄ° ---
    const sMap = { 'haber_trt': 'TRT', 'haber_cnn': 'CNN', 'haber_ntv': 'NTV', 'haber_webtekno': 'WEBTEKNO', 'haber_shiftdelete': 'SDN' };
    Object.keys(sMap).forEach(key => {
        db.ref(key + "/items").on("value", snap => {
            if(snap.val()) {
                const data = snap.val().slice(0, 10).map(i => ({...i, source: sMap[key]}));
                news = news.filter(x => x.source !== sMap[key]).concat(data).sort(() => Math.random() - 0.5);
                render();
            }
        });
    });

    function getBestImage(item, source) {
        if(item.enclosure?.link) return item.enclosure.link;
        if(item.thumbnail) return item.thumbnail;
        return 'https://via.placeholder.com/100';
    }

    function render() {
        const f = document.getElementById('newsFeed'); 
        if(!f) return;
        f.innerHTML = news.map((n, i) => `
            <div class="news-card" onclick="openDetail(${i})">
                <img src="${getBestImage(n, n.source)}">
                <div style="flex:1">
                    <div class="news-meta">${n.source}</div>
                    <div class="news-title">${n.title}</div>
                </div>
            </div>`).join('');
    }

// RESÄ°M YAKALAMA VE LOGO SÄ°STEMÄ°
    const logos = {
        'TRT': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/TRT_Haber_logo.svg/512px-TRT_Haber_logo.svg.png',
        'CNN': 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/CNN.svg/512px-CNN.svg.png',
        'NTV': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/NTV_Logo.svg/512px-NTV_Logo.svg.png',
        'WEBTEKNO': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Webtekno_Logo.png/512px-Webtekno_Logo.png',
        'SDN': 'https://shiftdelete.net/wp-content/themes/sdn/assets/img/logo.png'
    };

    // GELÄ°ÅMÄ°Å RESÄ°M YAKALAMA (NTV ve CNN Ä°Ã‡Ä°N Ã–ZEL)
    function getBestImage(item, source) {
        // 1. Standart Enclosure kontrolÃ¼
        if(item.enclosure?.link) return item.enclosure.link;
        if(item.thumbnail) return item.thumbnail;
        
        // 2. NTV/CNN iÃ§in description iÃ§indeki <img> tagÄ±nÄ± ayÄ±kla
        if (item.description && item.description.includes('<img')) {
            const regex = /<img[^>]+src="([^">]+)"/g;
            const match = regex.exec(item.description);
            if (match && match[1]) return match[1];
        }

        // 3. HiÃ§biri yoksa kaynaÄŸa Ã¶zel HD logo koy
        const logos = {
            'TRT': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/TRT_Haber_logo.svg/512px-TRT_Haber_logo.svg.png',
            'CNN': 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/CNN.svg/512px-CNN.svg.png',
            'NTV': 'https://upload.wikimedia.org/wikipedia/commons/b/b5/NTV_logo.png', // NTV HD Logo
            'WEBTEKNO': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Webtekno_Logo.png/512px-Webtekno_Logo.png',
            'SDN': 'https://shiftdelete.net/wp-content/themes/sdn/assets/img/logo.png'
        };
        return logos[source] || 'https://via.placeholder.com/100';
    }


    
    // --- 4. AYARLAR ---
    function openSettings() {
        const m = document.getElementById('mdl');
        m.innerHTML = `
            <div class="modal-header"><h2>AYARLAR</h2></div>
            <div class="modal-body">
                <div class="set-row"><label>YAZI BOYUTU</label><div class="set-ctrl"><button onclick="adjustSet('size',-1)">-</button><span>${sets.size}PX</span><button onclick="adjustSet('size',1)">+</button></div></div>
                <div class="set-row"><label>YAZI KALINLIÄI</label><div class="set-ctrl"><button onclick="adjustSet('weight',-100)">-</button><span>${sets.weight}</span><button onclick="adjustSet('weight',100)">+</button></div></div>
                <div class="set-row"><label>DAKTÄ°LO HIZI</label><div class="set-ctrl"><button onclick="adjustSet('speed',-5)">-</button><span>${sets.speed}</span><button onclick="adjustSet('speed',5)">+</button></div></div>
                <button class="btn-full" style="background:#ef4444; margin-top:10px;" onclick="clearHistory()">SOHBETÄ° SIFIRLA</button>
            </div>
            <div class="modal-footer"><button class="btn-full" onclick="closeM()">KAYDET</button></div>`;
        document.getElementById('ovl').style.display = 'flex';
    }

    function adjustSet(k, v) { sets[k] = Math.max(1, (sets[k] || 0) + v); applySets(); openSettings(); }
    function applySets() {
        document.documentElement.style.setProperty('--chat-size', sets.size + 'px');
        document.documentElement.style.setProperty('--chat-weight', sets.weight);
        localStorage.setItem('khoj_sets', JSON.stringify(sets));
    }

    // --- 5. KAYDETME SÄ°STEMÄ° ---
    function saveNews() {
        let saved = JSON.parse(localStorage.getItem('khoj_saved_news') || '[]');
        if(!saved.find(x => x.title === active.title)) {
            saved.push(active);
            localStorage.setItem('khoj_saved_news', JSON.stringify(saved));
            showToast("Haber Kaydedildi! ğŸ’¾");
        } else {
            showToast("Zaten KayÄ±tlÄ±!");
        }
    }

    function openSavedList() {
        const saved = JSON.parse(localStorage.getItem('khoj_saved_news') || '[]');
        const m = document.getElementById('mdl');
        let html = saved.length ? "" : "<p style='text-align:center; padding:20px;'>KayÄ±tlÄ± haber yok abi.</p>";
        saved.forEach((n, i) => {
            html += `<div class="news-card" style="margin-bottom:10px;">
                <img src="${getBestImage(n, n.source)}" style="width:40px; height:40px;">
                <div style="flex:1" onclick="openSavedDetail(${i})"><div class="news-title">${n.title}</div></div>
                <button onclick="deleteSaved(${i})" style="background:none; border:none; color:red;">ğŸ—‘ï¸</button>
            </div>`;
        });
        m.innerHTML = `<div class="modal-header"><h2>ğŸ’¾ KAYDEDÄ°LENLER</h2></div><div class="modal-body">${html}</div><div class="modal-footer"><button class="btn-full" onclick="closeM()">KAPAT</button></div>`;
        document.getElementById('ovl').style.display = 'flex';
    }

    function deleteSaved(i) {
        let saved = JSON.parse(localStorage.getItem('khoj_saved_news') || '[]');
        saved.splice(i, 1);
        localStorage.setItem('khoj_saved_news', JSON.stringify(saved));
        openSavedList();
    }
    
    function openSavedDetail(i) {
        active = JSON.parse(localStorage.getItem('khoj_saved_news'))[i];
        openDetail(-2);
    }

    // --- 6. SOHBET VE AI ---
    function openGeneralChat() {
        active = { title: "GENEL AI SOHBET", source: "KHOJ", description: "Haberden baÄŸÄ±msÄ±z genel sohbet modundasÄ±n." };
        openDetail(-1);
    }

    function openDetail(idx) {
        if(idx === -1) active = { title: "GENEL AI SOHBET", source: "KHOJ", description: "Her ÅŸeyi sorabilirsin abi." };
        else if(idx !== -2) active = news[idx];

        const m = document.getElementById('mdl');
        const img = getBestImage(active, active.source);
        
        m.innerHTML = `
            <div class="modal-header">
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <span class="news-meta">${active.source}</span>
                    <div style="display:flex; gap:10px;">
                        ${active.link ? `<button class="btn-icon" onclick="window.open('${active.link}','_blank')">ğŸ”—</button>` : ''}
                        <button class="btn-icon" onclick="saveNews()">ğŸ’¾</button>
                        <button class="btn-icon" style="color:red;" onclick="closeM()">âŒ</button>
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom:10px;">${active.title}</h3>
                ${active.source !== "KHOJ" ? `<img src="${img}" style="width:100%; border-radius:15px; margin-bottom:10px;">` : ''}
                <div class="chat-box" id="cBox" style="min-height:250px;">
                    ${(active.source === "KHOJ" && chatHistory.length > 0) ? 
                        chatHistory.map(msg => `<div class="msg ${msg.role === 'user' ? 'user' : 'ai'}">${msg.text}</div>`).join('') : 
                        `<div class="msg ai">Seni dinliyorum abi...</div>`
                    }
                </div>
            </div>
            <div class="modal-footer">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="uInp" placeholder="Bir ÅŸey yaz..." style="flex:1; padding:12px; border-radius:10px; border:1px solid #ddd;">
                    <button class="btn-icon btn-save" onclick="ask()">â¤</button>
                </div>
            </div>`;
        document.getElementById('ovl').style.display = 'flex';
        document.getElementById('cBox').scrollTop = 9999;
    }

    async function ask() {
        const inp = document.getElementById('uInp'); const box = document.getElementById('cBox');
        if(!inp.value) return; 
        const q = inp.value; inp.value = '';
        box.innerHTML += `<div class="msg user">${q}</div>`;
 // SÄ°HÄ°RLÄ° SATIR: Senin mesajÄ±n eklenince kutuyu ortalÄ±yoruz
    // Bu yÃ¶ntem id gerektirmez, en son eklenen mesajÄ± gÃ¶rÃ¼r
    box.scrollTo({
        top: box.scrollHeight - 150, // Seni tam yukarÄ± deÄŸil, biraz daha insancÄ±l bir yere Ã§eker
        behavior: 'smooth'
    });

    if(active.source === "KHOJ") chatHistory.push({role: 'user', text: q});
    //
        const ai = document.createElement('div'); ai.className = 'msg ai'; ai.innerHTML = '...';
        box.appendChild(ai); box.scrollTop = box.scrollHeight;

        try {
            const res = await fetch(KHOJ_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${KHOJ_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ q: `Haber: ${active.title}. Soru: ${q}`, stream: false })
            });
            const d = await res.json();
            let formatted = d.response.replace(/\*\*(.*?)\*\*/g, '<b style="color:#ef4444;">$1</b>').replace(/^\s*[\-\*]\s+/gm, 'ğŸ”¹ ').replace(/\n/g, '<br>');

            if(active.source === "KHOJ") {
                chatHistory.push({role: 'ai', text: formatted});
                localStorage.setItem('khoj_ai_history', JSON.stringify(chatHistory));
            }

            ai.innerHTML = '';
            let i = 0;
            function type() {
                if (i < formatted.length) {
                    if (formatted.substr(i, 1) === '<') {
                        let end = formatted.indexOf('>', i) + 1;
                        ai.innerHTML += formatted.substring(i, end); i = end;
                    } else {
                        ai.innerHTML += formatted.charAt(i); i++;
                    }
                    box.scrollTop = box.scrollHeight + 100; // Her yazÄ±mda kutuyu biraz daha fazla aÅŸaÄŸÄ± iter
                box.scrollTo({
    top: box.scrollHeight,
    behavior: 'auto' // 'smooth' yaparsak yazÄ± hÄ±zÄ±na yetiÅŸemez, 'auto' en iyisi
});
                    setTimeout(type, sets.speed);
                                    }
            }
            type();
        } catch (e) { ai.innerText = "BaÄŸlantÄ± hatasÄ±!"; }
    }

    function clearHistory() { chatHistory = []; localStorage.removeItem('khoj_ai_history'); closeM(); showToast("SÄ±fÄ±rlandÄ±!"); }
    function closeM() { document.getElementById('ovl').style.display = 'none'; }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }

    // --- PWA SERVICE WORKER KAYDI ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(reg => {
            console.log('Service Worker KayÄ±tlÄ±!', reg);
        }).catch(err => {
            console.log('Service Worker HatasÄ±:', err);
        });
    });
}

</script>
</body>
</html>
